<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>부산출발 랜드모아</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: "Noto Sans KR", sans-serif; background: #f5f5f5; padding: 20px; text-align: center; }
    .container { max-width: 1600px; margin: 0 auto; }
    .header { margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .header h1 { font-size: 28px; color: #333; }
    .header a { color: #333; text-decoration: none; }
    .search-bar { margin-bottom: 20px; }
    #search-input { width: 100%; max-width: 400px; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
    .upper-category-bar { margin-bottom: 10px; display: flex; justify-content: center; }
    .lower-category-bar { margin-bottom: 20px; display: none; justify-content: center; flex-wrap: wrap; }
    .category-btn { padding: 10px 20px; margin: 5px; border: none; background: #03C75A; color: white; border-radius: 5px; cursor: pointer; }
    .category-btn:hover, .category-btn.active { background: #029f47; }
    .masonry-container { display: grid; gap: 20px; width: 100%; grid-auto-flow: row; align-items: stretch; }
    .grid-item { width: 100%; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; cursor: pointer; transition: transform 0.3s; display: flex; flex-direction: column; height: 600px; }
    .grid-item:hover { transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.15); }
    .card-img { width: 100%; height: auto; max-height: 480px; overflow: hidden; position: relative; flex-shrink: 0; }
    .card-img img { width: 100%; height: 100%; object-fit: cover; object-position: top; display: block; }
    .card-img img.landscape { object-fit: contain; object-position: top; max-height: 480px; }
    .card-img img.portrait { max-height: 480px; object-fit: cover; }
    .card-content { padding: 10px 15px 20px; flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    .card-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 6px; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .card-excerpt { font-size: 14px; color: #555; line-height: 1.5; word-wrap: break-word; overflow: hidden; flex: 1; padding-bottom: 10px; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 5; text-overflow: ellipsis; }
    .card-excerpt.limited-text { -webkit-line-clamp: 2; }
    .card-timestamp { font-size: 12px; color: #888; margin-top: auto; }
    .card-text-only { padding: 10px 15px 20px; flex: 1; overflow: hidden; display: flex; flex-direction: column; }
    .card-text-only .card-excerpt { flex: 1; padding-bottom: 10px; overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 10; text-overflow: ellipsis; }
    .detail-view { display: none; background: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 30px; margin-bottom: 30px; }
    .detail-header { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; max-width: 800px; margin-left: auto; margin-right: auto; }
    .detail-title p { color: #666; font-size: 14px; }
    .detail-content { line-height: 1.8; margin-bottom: 30px; font-size: 16px; color: #333; max-width: 800px; margin-left: auto; margin-right: auto; text-align: left; }
    .first-paragraph { font-size: 22px; font-weight: 700; margin-bottom: 20px; color: #000; }
    .detail-images { display: flex; flex-direction: column; gap: 20px; align-items: center; }
    .detail-images img { max-width: 800px; width: 100%; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .accordion { background: #03C75A; color: white; cursor: pointer; padding: 15px; width: 100%; border: none; text-align: left; outline: none; font-size: 16px; transition: background 0.3s; margin-top: 20px; max-width: 800px; margin-left: auto; margin-right: auto; border-radius: 5px; }
    .accordion:hover, .accordion.active { background: #029f47; }
    .panel { padding: 0 15px; display: none; overflow: hidden; max-width: 800px; margin-left: auto; margin-right: auto; text-align: left; background: #fff; border-radius: 0 0 5px 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .panel p { padding: 15px; font-size: 16px; color: #333; }
    .panel a { color: #03C75A; text-decoration: none; }
    .panel a:hover { text-decoration: underline; }
    .refresh-button { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: #03C75A; color: white; border: none; border-radius: 50%; box-shadow: 0 3px 10px rgba(0,0,0,0.2); z-index: 10; cursor: pointer; }
    .refresh-button svg { width: 24px; height: 24px; }
    .error-message { display: none; position: fixed; top: 0; left: 0; right: 0; background: #f44336; color: white; padding: 10px; z-index: 1000; }
    @media (max-width: 1200px) { .grid-item { height: 540px; } .card-img { max-height: 432px; } .card-excerpt { -webkit-line-clamp: 4; } .card-excerpt.limited-text { -webkit-line-clamp: 2; } }
    @media (max-width: 900px) { .grid-item { height: 480px; } .card-img { max-height: 384px; } .card-excerpt { -webkit-line-clamp: 3; } .card-excerpt.limited-text { -webkit-line-clamp: 2; } }
    @media (max-width: 600px) { body { padding: 10px; } .detail-content { padding: 0 10px; } .grid-item { height: 420px; } .card-img { max-height: 336px; } .card-excerpt { -webkit-line-clamp: 2; } .card-excerpt.limited-text { -webkit-line-clamp: 1; } }
  </style>
</head>
<body>
  <div id="error-message" class="error-message">페이지 오류 - 새로고침 필요</div>
  <div class="container">
    <div class="header">
      <h1><a href="#" onclick="showList();return false;">부산출발 랜드모아</a></h1>
    </div>
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="게시물 검색 (예: 다낭)">
    </div>
    <div class="upper-category-bar">
      <button class="category-btn" data-category="">전체</button>
      <button class="category-btn" data-category="베트남">베트남</button>
      <button class="category-btn" data-category="필리핀">필리핀</button>
      <button class="category-btn" data-category="일본">일본</button>
      <button class="category-btn" data-category="중국">중국</button>
      <button class="category-btn" data-category="태국">태국</button>
      <button class="category-btn" data-category="발리">발리</button>
    </div>
    <div class="lower-category-bar" id="lower-category-bar"></div>
    <div id="detail-view" class="detail-view">
      <div class="detail-header">
        <div class="detail-title"><p id="detail-date"></p></div>
      </div>
      <div id="detail-content" class="detail-content"></div>
      <div id="detail-images" class="detail-images"></div>
      <button class="accordion">상품정보 출처</button>
      <div class="panel">
        <p id="band-link"></p>
      </div>
    </div>
    <div class="masonry-container" id="masonry-grid"></div>
  </div>
  <button class="refresh-button" onclick="location.reload()">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M23 4v6h-6"></path>
      <path d="M1 20v-6h6"></path>
      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
      <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
    </svg>
  </button>
  <script>
    const MAX_COLUMNS = 4;
    var postsData = [{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"환상제주","createdAt":1742286668,"bandUrl":"https://www.band.us/band/65044284"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"유니언재팬","createdAt":1742286667,"bandUrl":"https://www.band.us/band/68737327"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"크루즈투어&예인투어","createdAt":1742286667,"bandUrl":"https://www.band.us/band/62321043"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"티엔엠투어[대구지사]","createdAt":1742286667,"bandUrl":"https://www.band.us/band/95789098"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"라스투어 ☎051-442-3939","createdAt":1742286666,"bandUrl":"https://www.band.us/band/70805565"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"베스트 아시아","createdAt":1742286666,"bandUrl":"https://www.band.us/band/50166852"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"베트남항공 PSA 우리에이젠시","createdAt":1742286666,"bandUrl":"https://www.band.us/band/96999460"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"SM월드투어","createdAt":1742286665,"bandUrl":"https://www.band.us/band/57240332"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"VJT TOUR 일본전문랜드 T 051-714-1211","createdAt":1742286665,"bandUrl":"https://www.band.us/band/71920774"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"갤럭시투어","createdAt":1742286665,"bandUrl":"https://www.band.us/band/57078807"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"대건투어","createdAt":1742286665,"bandUrl":"https://www.band.us/band/51820573"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"BG투어 부산점051-463-0005","createdAt":1742286664,"bandUrl":"https://www.band.us/band/58200279"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"Land 발해투어","createdAt":1742286664,"bandUrl":"https://www.band.us/band/71890803"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"NFTour(엔에프투어) 051-710-8600","createdAt":1742286664,"bandUrl":"https://www.band.us/band/88119610"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"(주)유럽으로투어","createdAt":1742286663,"bandUrl":""},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"(주)일본여행","createdAt":1742286663,"bandUrl":"https://www.band.us/band/67564123"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"(주)다다투어 제주 전문랜드 (전국출발-김포,부산,대구,울산,경남)","createdAt":1742286662,"bandUrl":"https://www.band.us/band/66714594"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"(주)스마일 투어.  제주도 여행 전문  B2B","createdAt":1742286662,"bandUrl":""},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"(주)윈하나로투어 (호주/뉴질랜드 현지직영)","createdAt":1742286662,"bandUrl":"https://www.band.us/band/89743052"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"⚜️  투어.B  ☎️   051-632-3900","createdAt":1742286661,"bandUrl":""},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"(주)나눔투어 중국항공&아시아투어","createdAt":1742286661,"bandUrl":"https://www.band.us/band/6097945"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"B2B여행제휴네트워크","createdAt":1742286660,"bandUrl":"https://www.band.us/band/64162613"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"W투어 ☎ 051-467-3200","createdAt":1742286659,"bandUrl":"https://www.band.us/band/82152691"},{"title":"테스트 게시물 1","content":"두 번째 줄 테스트<br>세 번째 줄","photos":["https://via.placeholder.com/200x300"],"bandName":"에어부산전문판매대리점 더 투어","createdAt":1742286658,"bandUrl":""},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"환상제주","createdAt":1742200268,"bandUrl":"https://www.band.us/band/65044284"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"유니언재팬","createdAt":1742200267,"bandUrl":"https://www.band.us/band/68737327"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"크루즈투어&예인투어","createdAt":1742200267,"bandUrl":"https://www.band.us/band/62321043"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"티엔엠투어[대구지사]","createdAt":1742200267,"bandUrl":"https://www.band.us/band/95789098"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"라스투어 ☎051-442-3939","createdAt":1742200266,"bandUrl":"https://www.band.us/band/70805565"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"베스트 아시아","createdAt":1742200266,"bandUrl":"https://www.band.us/band/50166852"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"베트남항공 PSA 우리에이젠시","createdAt":1742200266,"bandUrl":"https://www.band.us/band/96999460"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"SM월드투어","createdAt":1742200265,"bandUrl":"https://www.band.us/band/57240332"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"VJT TOUR 일본전문랜드 T 051-714-1211","createdAt":1742200265,"bandUrl":"https://www.band.us/band/71920774"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"갤럭시투어","createdAt":1742200265,"bandUrl":"https://www.band.us/band/57078807"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"대건투어","createdAt":1742200265,"bandUrl":"https://www.band.us/band/51820573"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"BG투어 부산점051-463-0005","createdAt":1742200264,"bandUrl":"https://www.band.us/band/58200279"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"Land 발해투어","createdAt":1742200264,"bandUrl":"https://www.band.us/band/71890803"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"NFTour(엔에프투어) 051-710-8600","createdAt":1742200264,"bandUrl":"https://www.band.us/band/88119610"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"(주)유럽으로투어","createdAt":1742200263,"bandUrl":""},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"(주)일본여행","createdAt":1742200263,"bandUrl":"https://www.band.us/band/67564123"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"(주)다다투어 제주 전문랜드 (전국출발-김포,부산,대구,울산,경남)","createdAt":1742200262,"bandUrl":"https://www.band.us/band/66714594"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"(주)스마일 투어.  제주도 여행 전문  B2B","createdAt":1742200262,"bandUrl":""},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"(주)윈하나로투어 (호주/뉴질랜드 현지직영)","createdAt":1742200262,"bandUrl":"https://www.band.us/band/89743052"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"⚜️  투어.B  ☎️   051-632-3900","createdAt":1742200261,"bandUrl":""},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"(주)나눔투어 중국항공&아시아투어","createdAt":1742200261,"bandUrl":"https://www.band.us/band/6097945"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"B2B여행제휴네트워크","createdAt":1742200260,"bandUrl":"https://www.band.us/band/64162613"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"W투어 ☎ 051-467-3200","createdAt":1742200259,"bandUrl":"https://www.band.us/band/82152691"},{"title":"테스트 게시물 2","content":"추가 내용 테스트<br>또 다른 줄","photos":["https://via.placeholder.com/300x200"],"bandName":"에어부산전문판매대리점 더 투어","createdAt":1742200258,"bandUrl":""}];
    var originalPostsData = JSON.parse(JSON.stringify(postsData));
    var currentIndex = 0;
    var batchSize = 10;
    var isLoadingMore = false;
    var lastScrollPosition = 0;
    var scrollHandler = null;

const categoryMap = {
  "베트남": ["다낭", "나트랑", "푸꾸옥", "하노이", "호치민"],
  "필리핀": ["보홀", "세부", "마닐라", "보라카이"],
  "일본": ["오사카", "후쿠오카", "도쿄", "동경", "북해도", "대마도", "마쓰야마"],
  "중국": ["하이난", "백두산", "장가계", "청도", "북경"],
  "태국": ["방콕", "치앙마이"]
};

    document.addEventListener("DOMContentLoaded", initializeApp);

    function formatDate(timestamp) {
      if (!timestamp || isNaN(timestamp)) return "시간 정보 없음";
      var tsLength = String(timestamp).length;
      var date = tsLength > 10 ? new Date(parseInt(timestamp)) : new Date(parseInt(timestamp) * 1000);
      if (date.getFullYear() < 1970 || date.getFullYear() > 2100) return "시간 정보 없음";
      return date.getFullYear() + "-" + 
             String(date.getMonth() + 1).padStart(2, "0") + "-" + 
             String(date.getDate()).padStart(2, "0") + " " + 
             String(date.getHours()).padStart(2, "0") + ":" + 
             String(date.getMinutes()).padStart(2, "0");
    }

    function setColumnCount() {
      var masonryContainer = document.getElementById("masonry-grid");
      if (!masonryContainer) return;
      var width = window.innerWidth;
      var columns = width <= 600 ? 2 : width <= 900 ? 3 : width <= 1200 ? MAX_COLUMNS : MAX_COLUMNS;
      var cardHeight = width <= 600 ? 420 : width <= 900 ? 480 : width <= 1200 ? 540 : 600;
      var imgHeight = width <= 600 ? 336 : width <= 900 ? 384 : width <= 1200 ? 432 : 480;
      masonryContainer.style.gridTemplateColumns = "repeat(" + columns + ", 1fr)";
      document.querySelectorAll(".grid-item").forEach(function(item) {
        item.style.height = cardHeight + "px";
        var cardImg = item.querySelector(".card-img");
        if (cardImg) cardImg.style.maxHeight = imgHeight + "px";
      });
    }

    window.addEventListener("resize", setColumnCount);

    function safeExecute(fn, errorMessage) {
      try {
        return fn();
      } catch (e) {
        console.error(errorMessage || "오류 발생", e);
        showErrorMessage("오류: " + (errorMessage || e.message));
        return null;
      }
    }

    function initializeApp() {
      safeExecute(function() {
        var urlParams = new URLSearchParams(window.location.search);
        var postId = urlParams.get("post");
        var grid = document.getElementById("masonry-grid");
        var detailView = document.getElementById("detail-view");

        if (!grid || !detailView) throw new Error("DOM 요소 누락");
        if (postId && postsData[postId]) {
          showDetail(parseInt(postId), false);
        } else {
          showList(false);
        }

        scrollHandler = debounce(function() {
          if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && 
              currentIndex < postsData.length && !isLoadingMore) {
            loadMorePosts();
          }
        }, 200);
        window.addEventListener("scroll", scrollHandler);

        var accordion = document.querySelector(".accordion");
        accordion.addEventListener("click", function() {
          this.classList.toggle("active");
          var panel = this.nextElementSibling;
          panel.style.display = panel.style.display === "block" ? "none" : "block";
        });

        document.getElementById("search-input").addEventListener("input", function(e) {
          filterPosts(e.target.value);
        });

        document.querySelectorAll(".upper-category-bar .category-btn").forEach(function(btn) {
          btn.addEventListener("click", function() {
            filterByUpperCategory(this.getAttribute("data-category"));
          });
        });

        filterByUpperCategory("");
      }, "초기화 오류");
    }

    function debounce(func, wait) {
      var timeout;
      return function() {
        clearTimeout(timeout);
        timeout = setTimeout(func, wait);
      };
    }

    function filterPosts(query) {
      var filtered = query ? originalPostsData.filter(function(post) {
        return post.title.toLowerCase().includes(query.toLowerCase()) || 
               post.content.toLowerCase().includes(query.toLowerCase());
      }) : originalPostsData;
      currentIndex = 0;
      var grid = document.getElementById("masonry-grid");
      grid.innerHTML = "";
      postsData = filtered;
      loadMorePosts();
      document.getElementById("lower-category-bar").style.display = "none";
    }

    function filterByUpperCategory(upperCategory) {
      var filtered = upperCategory ? originalPostsData.filter(function(post) {
        return post.title.includes(upperCategory) || post.content.includes(upperCategory);
      }) : originalPostsData;
      currentIndex = 0;
      var grid = document.getElementById("masonry-grid");
      grid.innerHTML = "";
      postsData = filtered;
      loadMorePosts();

      document.querySelectorAll(".upper-category-bar .category-btn").forEach(function(btn) {
        btn.classList.toggle("active", btn.getAttribute("data-category") === upperCategory);
      });

      var lowerBar = document.getElementById("lower-category-bar");
      lowerBar.innerHTML = "";
      if (categoryMap[upperCategory]) {
        categoryMap[upperCategory].forEach(function(lower) {
          var btn = document.createElement("button");
          btn.className = "category-btn";
          btn.setAttribute("data-category", lower);
          btn.textContent = lower;
          btn.addEventListener("click", function() {
            filterByLowerCategory(upperCategory, lower);
          });
          lowerBar.appendChild(btn);
        });
        lowerBar.style.display = "flex";
      } else {
        lowerBar.style.display = "none";
      }
    }

function filterByLowerCategory(upperCategory, lowerCategory) {
  var filtered = originalPostsData.filter(function(post) {
    return (post.title.includes(upperCategory) || post.content.includes(upperCategory)) ||
           (post.title.includes(lowerCategory) || post.content.includes(lowerCategory));
  });
  currentIndex = 0;
  var grid = document.getElementById("masonry-grid");
  grid.innerHTML = "";
  postsData = filtered;
  loadMorePosts();

  document.querySelectorAll(".lower-category-bar .category-btn").forEach(function(btn) {
    btn.classList.toggle("active", btn.getAttribute("data-category") === lowerCategory);
  });
}

    function loadInitialPosts() {
      safeExecute(function() {
        currentIndex = 0;
        isLoadingMore = false;
        var grid = document.getElementById("masonry-grid");
        if (!grid) return;

        grid.innerHTML = postsData.length ? "" : '<div style="text-align:center;padding:30px;color:#666;">최근 게시물 없음</div>';
        if (postsData.length) loadMorePosts();
        setColumnCount();
      }, "초기 로드 오류");
    }

    function loadMorePosts() {
      if (isLoadingMore) return;
      isLoadingMore = true;

      safeExecute(function() {
        var grid = document.getElementById("masonry-grid");
        if (!grid) return;

        var fragment = document.createDocumentFragment();
        var end = Math.min(currentIndex + batchSize, postsData.length);

        for (var i = currentIndex; i < end; i++) {
          var post = postsData[i];
          var card = document.createElement("div");
          card.className = "grid-item";
          card.setAttribute("data-index", i);
          card.onclick = function(index) { return function() { showDetail(index); }; }(i);
          card.innerHTML = post.photos && post.photos.length && post.photos[0] ?
            '<div class="card-img"><img src="' + post.photos[0] + '" loading="lazy" alt="게시물 이미지" onerror="this.parentNode.parentNode.innerHTML=createTextOnlyHTML(' + i + ')"></div>' +
            '<div class="card-content"><div class="card-title">' + post.title + '</div><div class="card-excerpt">' + (post.content || "") + '</div><div class="card-timestamp">' + formatDate(post.createdAt) + '</div></div>' :
            '<div class="card-text-only"><div class="card-title">' + post.title + '</div><div class="card-excerpt">' + (post.content || "") + '</div><div class="card-timestamp">' + formatDate(post.createdAt) + '</div></div>';
          fragment.appendChild(card);
        }

        grid.appendChild(fragment);
        currentIndex = end;

        var images = grid.querySelectorAll(".card-img img");
        images.forEach(function(img) {
          if (img.complete) adjustImageAspectRatio(img);
          else {
            img.onload = function() { adjustImageAspectRatio(img); };
            img.onerror = function() { this.parentNode.parentNode.innerHTML = createTextOnlyHTML(this.closest(".grid-item").getAttribute("data-index")); };
          }
        });
        setColumnCount();
      }, "추가 로드 오류");

      isLoadingMore = false;
    }

    function adjustImageAspectRatio(img) {
      var aspectRatio = img.naturalWidth / img.naturalHeight;
      if (aspectRatio > 1) img.classList.add("landscape");
      else img.classList.add("portrait");

      var card = img.closest(".grid-item");
      var cardHeight = parseFloat(getComputedStyle(card).height);
      var imgHeight = img.getBoundingClientRect().height;
      if (imgHeight >= cardHeight * 0.7) {
        var excerpt = card.querySelector(".card-excerpt");
        if (excerpt) excerpt.classList.add("limited-text");
      }
    }

    function createTextOnlyHTML(index) {
      return safeExecute(function() {
        var post = postsData[index];
        return '<div class="card-text-only"><div class="card-title">' + post.title + '</div><div class="card-excerpt">' + (post.content || "") + '</div><div class="card-timestamp">' + formatDate(post.createdAt) + '</div></div>';
      }, "텍스트 HTML 오류") || '<div class="card-text-only"><div class="card-title">제목 로드 실패</div><div class="card-excerpt">내용 로드 실패</div><div class="card-timestamp">시간 정보 없음</div></div>';
    }

    function showDetail(index, saveState) {
      saveState = saveState !== false;
      safeExecute(function() {
        var post = postsData[index];
        if (!post) return;

        lastScrollPosition = window.scrollY;
        var detailView = document.getElementById("detail-view");
        var grid = document.getElementById("masonry-grid");
        var detailDate = document.getElementById("detail-date");
        var detailContent = document.getElementById("detail-content");
        var imagesContainer = document.getElementById("detail-images");
        var bandLink = document.getElementById("band-link");
        var searchBar = document.querySelector(".search-bar");
        var upperCategoryBar = document.querySelector(".upper-category-bar");
        var lowerCategoryBar = document.querySelector(".lower-category-bar");

        if (!detailView || !grid || !detailDate || !detailContent || !imagesContainer || !bandLink) throw new Error("상세 DOM 요소 누락");

        detailDate.textContent = formatDate(post.createdAt);
        detailContent.innerHTML = formatContentWithTitleParagraph(post.title + "<br>" + (post.content || ""));
        imagesContainer.innerHTML = "";
        if (post.photos && post.photos.length) loadDetailImages(post.photos, imagesContainer);
        bandLink.innerHTML = post.bandUrl ? '<a href="' + post.bandUrl + '" target="_blank">' + post.bandName + '</a>' : post.bandName;

        detailView.style.display = "block";
        grid.style.display = "none";
        searchBar.style.display = "none";
        upperCategoryBar.style.display = "none";
        lowerCategoryBar.style.display = "none";
        window.scrollTo(0, 0);

        if (saveState) {
          window.history.pushState({ postId: index, view: "detail" }, "", "?post=" + index);
          sessionStorage.setItem("bandPostsState", JSON.stringify({ view: "detail", postId: index }));
        }
      }, "상세 표시 오류");
    }

    function loadDetailImages(photoUrls, container) {
      safeExecute(function() {
        var fragment = document.createDocumentFragment();
        photoUrls.forEach(function(url) {
          if (!url) return;
          var img = document.createElement("img");
          img.src = url;
          img.alt = "게시물 이미지";
          img.loading = "lazy";
          img.onerror = function() { this.style.display = "none"; };
          fragment.appendChild(img);
        });
        container.appendChild(fragment);
      }, "이미지 로드 오류");
    }

    function formatContentWithTitleParagraph(content) {
      return safeExecute(function() {
        var paragraphs = content.split("<br>").filter(p => p.trim());
        if (paragraphs.length) {
          var html = '<p class="first-paragraph">' + paragraphs[0] + '</p>';
          for (var i = 1; i < paragraphs.length; i++) html += "<p>" + paragraphs[i] + "</p>";
          return html;
        }
        return content || "내용 없음";
      }, "컨텐츠 포맷 오류") || content || "내용 없음";
    }

    function showList(saveState) {
      saveState = saveState !== false;
      safeExecute(function() {
        var detailView = document.getElementById("detail-view");
        var grid = document.getElementById("masonry-grid");
        var searchBar = document.querySelector(".search-bar");
        var upperCategoryBar = document.querySelector(".upper-category-bar");
        var lowerCategoryBar = document.querySelector(".lower-category-bar");
        if (!detailView || !grid) return;

        detailView.style.display = "none";
        grid.style.display = "grid";
        searchBar.style.display = "block";
        upperCategoryBar.style.display = "flex";
        lowerCategoryBar.style.display = postsData !== originalPostsData ? "flex" : "none";
        loadInitialPosts();
        window.scrollTo(0, lastScrollPosition);

        if (saveState) {
          window.history.pushState({ view: "list" }, "", window.location.pathname);
          sessionStorage.setItem("bandPostsState", JSON.stringify({ view: "list" }));
        }
      }, "목록 표시 오류");
    }

    window.addEventListener("popstate", function(event) {
      safeExecute(function() {
        var state = event.state || JSON.parse(sessionStorage.getItem("bandPostsState") || "{}");
        if (state.view === "detail" && postsData[state.postId]) showDetail(state.postId, false);
        else showList(false);
      }, "히스토리 오류");
    });

    function showErrorMessage(message) {
      var errorMessage = document.getElementById("error-message");
      if (!errorMessage) return;
      errorMessage.textContent = message || "오류 발생 - 새로고침 필요";
      errorMessage.style.display = "block";
      setTimeout(function() { errorMessage.style.display = "none"; }, 3000);
    }
  </script>
</body>
</html>